name: Deploy
description: Deploy the build artifact to the server

on:
  workflow_call:
    inputs:
      build_name:
        required: true
        type: string
      environment:
        required: true
        type: string

  workflow_dispatch:
    inputs:
      run_id:
        description: 'The GitHub Actions run ID of the build to deploy'
        required: false
        type: string
      build_name:
        description: 'The name of the build artifact to deploy'
        required: true
        type: string
      environment:
        description: 'The deployment environment'
        required: true
        type: environment

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Download the build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build_name }}
          path: ~/build
          run-id: ${{ inputs.run_id || github.run_id }}

      - name: Copy the build to the server using rsync
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.INSTANCE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.INSTANCE_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/id_rsa
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" --delete ~/build/ ${{ secrets.INSTANCE_USERNAME }}@${{ secrets.INSTANCE_HOST }}:~/build/

      - name: Write .env file to the server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.INSTANCE_USERNAME }}@${{ secrets.INSTANCE_HOST }} "bash -c 'cat > ~/build/.env <<EOF
          MOTD_ROOT_ADMINS=\"${{ secrets.MOTD_ROOT_ADMINS }}\"
          MOTD_WEB_PORT=\"${{ secrets.MOTD_WEB_PORT }}\"
          MOTD_DOMAIN=\"${{ secrets.MOTD_DOMAIN }}\"
          MOTD_EMAIL=\"${{ secrets.MOTD_EMAIL }}\"
          MOTD_DEBUG_LOG=\"${{ vars.MOTD_DEBUG_LOG }}\"
          MOTD_EFPS_KEY=\"${{ secrets.MOTD_EFPS_KEY }}\"
          MOTD_MAXMIND_LICENSE_KEY=\"${{ secrets.MOTD_MAXMIND_LICENSE_KEY }}\"
          POSTGRES_HOST=\"${{ secrets.POSTGRES_HOST }}\"
          POSTGRES_PORT=\"${{ secrets.POSTGRES_PORT }}\"
          POSTGRES_USER=\"${{ secrets.POSTGRES_USER }}\"
          POSTGRES_PASSWORD=\"${{ secrets.POSTGRES_PASSWORD }}\"
          TELEGRAM_API_ID=\"${{ secrets.TELEGRAM_API_ID }}\"
          TELEGRAM_API_HASH=\"${{ secrets.TELEGRAM_API_HASH }}\"
          YANDEX_TRANSLATE_API_KEY=\"${{ secrets.YANDEX_TRANSLATE_API_KEY }}\"
          EOF'"

      - name: Write prometheus web config to the server (via decoded base64)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.INSTANCE_USERNAME }}@${{ secrets.INSTANCE_HOST }} <<'EOF'
            mkdir -p ~/build/prometheus
            echo "basic_auth_users:" > ~/build/prometheus/web.yaml
            echo -n "  admin: \"" >> ~/build/prometheus/web.yaml
            echo "${{ secrets.PROM_PASSWORD_BCRYPT_B64 }}" | base64 -d >> ~/build/prometheus/web.yaml
            echo "\"" >> ~/build/prometheus/web.yaml
          EOF


      - name: Deploy the build
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.INSTANCE_USERNAME }}@${{ secrets.INSTANCE_HOST }} "
          cd ~/build && docker compose -p motd-menu up --build -d"
